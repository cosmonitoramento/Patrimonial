<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BROI Analytics - Dashboard Moderno</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #16213e;
            --bg-glass: rgba(255, 255, 255, 0.05);
            --bg-glass-hover: rgba(255, 255, 255, 0.08);
            --accent-primary: #4f46e5;
            --accent-secondary: #06b6d4;
            --accent-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --accent-blue: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --accent-purple: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --accent-green: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --accent-orange: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --text-primary: #ffffff;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --border-primary: rgba(255, 255, 255, 0.1);
            --border-secondary: rgba(255, 255, 255, 0.05);
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 15px 0 rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 30px 0 rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 20px rgba(103, 232, 249, 0.3);
            --border-radius: 16px;
            --border-radius-lg: 24px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --bg-glass: rgba(255, 255, 255, 0.7);
            --bg-glass-hover: rgba(255, 255, 255, 0.9);
            --text-primary: #000000;
            --text-secondary: #1f2937;
            --text-muted: #4b5563;
            --border-primary: rgba(0, 0, 0, 0.1);
            --border-secondary: rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 15px 0 rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 30px 0 rgba(0, 0, 0, 0.1);
            --shadow-glow: 0 0 20px rgba(103, 232, 249, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
            animation: backgroundShift 20s ease-in-out infinite;
        }

        @keyframes backgroundShift {
            0%, 100% { background-position: 0% 50%, 100% 50%, 50% 50%; }
            50% { background-position: 100% 50%, 0% 50%, 50% 0%; }
        }

        .header {
            background: var(--bg-glass);
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid var(--border-primary);
            padding: 1.5rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow-md);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: var(--accent-gradient);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
            box-shadow: var(--shadow-glow);
        }

        .logo-text h1 {
            font-size: 1.75rem;
            font-weight: 800;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-text p {
            font-size: 0.875rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .theme-toggle {
            background: var(--bg-glass);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 0.75rem;
            cursor: pointer;
            transition: var(--transition);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
        }

        .theme-toggle:hover {
            background: var(--bg-glass-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        .controls-panel {
            background: var(--bg-glass);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--border-primary);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-md);
            animation: slideInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .filter-group {
            position: relative;
        }

        .filter-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .filter-input, .filter-select {
            width: 100%;
            padding: 1rem 1.25rem;
            background: var(--bg-glass);
            border: 1px solid var(--border-primary);
            border-radius: var(--border-radius);
            color: var(--text-primary);
            font-size: 0.925rem;
            font-weight: 500;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
            background: var(--bg-glass-hover);
        }

        .filter-input::placeholder {
            color: var(--text-muted);
        }

        .actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 0.925rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--accent-gradient);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--bg-glass);
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--bg-glass-hover);
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--accent-green);
            color: white;
        }

        .btn-warning {
            background: var(--accent-orange);
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: var(--bg-glass);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--border-primary);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            position: relative;
            overflow: hidden;
            transition: var(--transition);
            animation: fadeInScale 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--accent-gradient);
        }

        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-lg);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }

        .stat-title {
            font-size: 0.875rem;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: var(--accent-gradient);
            color: white;
            box-shadow: var(--shadow-glow);
        }

        .stat-value {
            font-size: 3rem;
            font-weight: 800;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 1rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 2rem;
        }

        .chart-card {
            background: var(--bg-glass);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--border-primary);
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            transition: var(--transition);
            box-shadow: var(--shadow-md);
            animation: slideInUp 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .chart-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .chart-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-secondary);
            background: var(--bg-glass);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .chart-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.875rem;
        }

        .chart-actions {
            display: flex;
            gap: 0.5rem;
        }

        .chart-btn {
            background: var(--bg-glass);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 0.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .chart-btn:hover {
            background: var(--bg-glass-hover);
            color: var(--text-primary);
            transform: scale(1.1);
        }

        .chart-content {
            padding: 2rem;
            height: 450px;
            position: relative;
        }

        .chart-canvas {
            width: 100% !important;
            height: 100% !important;
        }

        .no-data {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            text-align: center;
        }

        .no-data-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--bg-glass);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--border-primary);
            border-radius: var(--border-radius-lg);
            max-width: 90vw;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
            animation: slideInScale 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideInScale {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-glass);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .modal-body {
            padding: 2rem;
            overflow: auto;
            flex: 1;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-secondary);
        }

        .data-table th {
            background: var(--bg-glass);
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: sticky;
            top: 0;
            backdrop-filter: blur(10px);
        }

        .data-table tbody tr {
            transition: var(--transition);
        }

        .data-table tbody tr:hover {
            background: var(--bg-glass-hover);
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            animation: fadeIn 0.3s ease;
        }

        .loading-content {
            background: var(--bg-glass);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--border-primary);
            border-radius: var(--border-radius-lg);
            padding: 3rem;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 3px solid var(--border-primary);
            border-top: 3px solid var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--bg-glass);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--border-primary);
            border-radius: var(--border-radius);
            padding: 1rem 1.5rem;
            box-shadow: var(--shadow-lg);
            z-index: 4000;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transform: translateX(400px);
            opacity: 0;
            transition: var(--transition);
            max-width: 400px;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            color: white;
        }

        .toast.success .toast-icon { background: var(--accent-green); }
        .toast.error .toast-icon { background: var(--accent-purple); }
        .toast.warning .toast-icon { background: var(--accent-orange); }
        .toast.info .toast-icon { background: var(--accent-blue); }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header-content {
                padding: 0 1rem;
                flex-direction: column;
                gap: 1rem;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .actions-bar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn-group {
                justify-content: center;
            }
            
            .chart-content {
                height: 350px;
                padding: 1rem;
            }
        }

        /* Animações de entrada escalonadas */
        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }
        .stat-card:nth-child(4) { animation-delay: 0.4s; }
        .stat-card:nth-child(5) { animation-delay: 0.5s; }
        .stat-card:nth-child(6) { animation-delay: 0.6s; }

        .chart-card:nth-child(1) { animation-delay: 0.2s; }
        .chart-card:nth-child(2) { animation-delay: 0.4s; }
        .chart-card:nth-child(3) { animation-delay: 0.6s; }
        .chart-card:nth-child(4) { animation-delay: 0.8s; }
    </style>
</head>
    <body data-theme="light">
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">B</div>
                <div class="logo-text">
                    <h1>BROI Analytics</h1>
                    <p>Sistema Inteligente de Monitoramento</p>
                </div>
            </div>
            <div class="header-actions">
                <button class="theme-toggle" onclick="toggleTheme()">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>
    </header>

    <div class="container">
        <section class="controls-panel">
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label" for="dataInicio">Data Inicial</label>
                    <input type="date" id="dataInicio" class="filter-input">
                </div>
                <div class="filter-group">
                    <label class="filter-label" for="dataFim">Data Final</label>
                    <input type="date" id="dataFim" class="filter-input">
                </div>
                <div class="filter-group">
                    <label class="filter-label" for="gerenciaFilter">Gerência</label>
                    <select id="gerenciaFilter" class="filter-select">
                        <option value="">Todas as Gerências</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label" for="empresaFilter">Empresa</label>
                    <select id="empresaFilter" class="filter-select">
                        <option value="">Todas as Empresas</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label" for="tipificacaoFilter">Tipificação</label>
                    <select id="tipificacaoFilter" class="filter-select">
                        <option value="">Todas as Tipificações</option>
                    </select>
                </div>
            </div>
            
            <div class="actions-bar">
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="applyFilters()">
                        <i class="fas fa-filter"></i>
                        Aplicar Filtros
                    </button>
                    <button class="btn btn-secondary" onclick="refreshData()">
                        <i class="fas fa-sync-alt"></i>
                        Atualizar
                    </button>
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="exportCSV()">
                        <i class="fas fa-file-csv"></i>
                        Exportar CSV
                    </button>
                    <button class="btn btn-warning" onclick="exportPDF()">
                        <i class="fas fa-file-pdf"></i>
                        Relatório PDF
                    </button>
                </div>
            </div>
        </section>

        <section class="stats-grid" id="statsContainer">
            <!-- Stats preenchidas dinamicamente -->
        </section>

        <section class="charts-grid" id="chartsContainer">
            <!-- Gráficos preenchidos dinamicamente -->
        </section>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Detalhes</h3>
                <button class="chart-btn" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Conteúdo dinâmico -->
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div id="loading" class="loading hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3>Carregando dados...</h3>
            <p>Processando informações em tempo real</p>
            <button class="btn btn-secondary" onclick="hideLoading()" style="margin-top: 1rem;">
                <i class="fas fa-times"></i>
                Cancelar
            </button>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast">
        <div class="toast-icon">
            <i class="fas fa-check"></i>
        </div>
        <div class="toast-message">
            Mensagem do sistema
        </div>
    </div>

    <script>
        // ===== CONFIGURAÇÕES GLOBAIS =====
        let rawData = [];
        let filteredData = [];
        let charts = {};
        let isLoading = false;
        
        // Configuração de sistema
        const systemConfig = {
            timeout: 5000,
            retries: 3,
            baseUrl: 'https://script.google.com/macros/s/',
            debug: false
        };
        
        // Token de configuração para API externa
        const apiToken = 'AKfycbyGibVjw2Bc0x7LzBnNq8iIaPdG';

        // ===== CONFIGURAÇÃO DE GRÁFICOS MODERNOS =====
        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.font.size = 12;
        Chart.defaults.color = '#000000'; // Cor padrão preta para tema claro
        Chart.defaults.plugins.legend.labels.usePointStyle = true;
        Chart.defaults.plugins.legend.labels.padding = 20;
        Chart.defaults.elements.point.radius = 6;
        Chart.defaults.elements.point.hoverRadius = 8;
        Chart.defaults.elements.line.borderWidth = 3;
        Chart.defaults.elements.bar.borderRadius = 8;

        // ===== GRADIENTES MODERNOS =====
        const gradients = {
            blue: ['#667eea', '#764ba2'],
            purple: ['#f093fb', '#f5576c'],
            green: ['#4facfe', '#00f2fe'],
            orange: ['#43e97b', '#38f9d7'],
            pink: ['#fa709a', '#fee140'],
            cyan: ['#a8edea', '#fed6e3']
        };

        // Configurações de autenticação para serviços externos
        const authConfig = {
            key: '_G8Q5TbLnCx59U1SWsvx3mHxZdqC9dtTV-uUWDCoJA',
            timeout: 10000
        };

        // ===== INICIALIZAÇÃO =====
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });

        function initializeApp() {
            setupDates();
            setupEventListeners();
            loadData();
        }

        function setupDates() {
            const today = new Date();
            const dataInicial = new Date('2022-01-01'); // Data fixa: 1º de janeiro de 2022
            
            document.getElementById('dataInicio').valueAsDate = dataInicial;
            document.getElementById('dataFim').valueAsDate = today;
        }

        function setupEventListeners() {
            // Filtros automáticos
            document.getElementById('gerenciaFilter').addEventListener('change', debounce(applyFilters, 300));
            document.getElementById('empresaFilter').addEventListener('change', debounce(applyFilters, 300));
            document.getElementById('tipificacaoFilter').addEventListener('change', debounce(applyFilters, 300));
            
            // Modal
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeModal();
            });
            
            // Atalhos de teclado
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey)) {
                    switch(e.key) {
                        case 'r':
                            e.preventDefault();
                            refreshData();
                            break;
                        case 'e':
                            e.preventDefault();
                            exportCSV();
                            break;
                        case 'p':
                            e.preventDefault();
                            exportPDF();
                            break;
                    }
                }
            });
        }

        // ===== UTILITÁRIOS =====
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function showLoading() {
            if (isLoading) return;
            isLoading = true;
            document.getElementById('loading').classList.remove('hidden');
        }

        function hideLoading() {
            isLoading = false;
            document.getElementById('loading').classList.add('hidden');
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const icons = {
                success: 'fa-check',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            toast.querySelector('.toast-icon i').className = `fas ${icons[type]}`;
            toast.querySelector('.toast-message').textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }

        function toggleTheme() {
            const body = document.body;
            const icon = document.querySelector('.theme-toggle i');
            const isDark = body.getAttribute('data-theme') === 'dark';
            
            body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            icon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
            
            // Atualizar cores dos gráficos
            updateChartsTheme();
            
            showToast(`Tema ${isDark ? 'claro' : 'escuro'} ativado`, 'success');
        }

        function updateChartsTheme() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? 'rgba(255, 255, 255, 0.8)' : '#000000';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

            // Atualizar cor padrão global
            Chart.defaults.color = textColor;

            Object.values(charts).forEach(chart => {
                if (chart?.options?.plugins?.legend?.labels) {
                    chart.options.plugins.legend.labels.color = textColor;
                }
                if (chart?.options?.scales) {
                    Object.values(chart.options.scales).forEach(scale => {
                        if (scale.ticks) scale.ticks.color = textColor;
                        if (scale.grid) scale.grid.color = gridColor;
                    });
                }
                chart?.update?.('none');
            });
        }

        // ===== CARREGAMENTO DE DADOS =====
        async function loadData() {
            showLoading();
            
            try {
                // Construir URL da API a partir das configurações distribuídas
                const API_URL = systemConfig.baseUrl + apiToken + authConfig.key + endpoints.main;
                
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                if (!Array.isArray(data) || data.length === 0) {
                    throw new Error('Dados inválidos recebidos da API');
                }
                
                rawData = data;
                populateFilters();
                applyFilters();
                showToast('Dados carregados com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showToast(`Erro ao carregar dados: ${error.message}`, 'error');
                showErrorState();
            } finally {
                hideLoading();
            }
        }

        function refreshData() {
            // Destruir gráficos existentes
            Object.values(charts).forEach(chart => {
                try {
                    chart.destroy();
                } catch (e) {
                    console.warn('Erro ao destruir gráfico:', e);
                }
            });
            charts = {};
            
            // Recarregar dados
            loadData();
        }

        function populateFilters() {
            const gerencias = [...new Set(rawData.map(item => item.Gerência).filter(Boolean))].sort();
            const empresas = [...new Set(rawData.map(item => item.Empresa).filter(Boolean))].sort();
            const tipificacoes = [...new Set(rawData.map(item => item.Tipificação).filter(Boolean))].sort();
            
            populateSelect('gerenciaFilter', gerencias, 'Todas as Gerências');
            populateSelect('empresaFilter', empresas, 'Todas as Empresas');
            populateSelect('tipificacaoFilter', tipificacoes, 'Todas as Tipificações');
        }

        function populateSelect(id, options, placeholder) {
            const select = document.getElementById(id);
            const currentValue = select.value;
            
            select.innerHTML = `<option value="">${placeholder}</option>`;
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                if (option === currentValue) opt.selected = true;
                select.appendChild(opt);
            });
        }

        // ===== FILTROS =====
        function applyFilters() {
            const dataInicio = document.getElementById('dataInicio').valueAsDate;
            const dataFim = document.getElementById('dataFim').valueAsDate;
            const gerencia = document.getElementById('gerenciaFilter').value;
            const empresa = document.getElementById('empresaFilter').value;
            const tipificacao = document.getElementById('tipificacaoFilter').value;
            
            filteredData = rawData.filter(item => {
                try {
                    const itemDate = new Date(item.Data);
                    
                    if (dataInicio && itemDate < dataInicio) return false;
                    if (dataFim && itemDate > dataFim) return false;
                    if (gerencia && item.Gerência !== gerencia) return false;
                    if (empresa && item.Empresa !== empresa) return false;
                    if (tipificacao && item.Tipificação !== tipificacao) return false;
                    
                    return true;
                } catch (error) {
                    console.warn('Erro ao filtrar item:', item, error);
                    return false;
                }
            });
            
            updateStats();
            createCharts();
            
            if (filteredData.length === 0) {
                showToast('Nenhum resultado encontrado para os filtros aplicados', 'warning');
            } else {
                showToast(`${filteredData.length} registros encontrados`, 'info');
            }
        }

        // ===== ESTATÍSTICAS =====
        function updateStats() {
            const stats = calculateStats(filteredData);
            
            document.getElementById('statsContainer').innerHTML = `
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Total BROI</div>
                        <div class="stat-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                    <div class="stat-value">${stats.total.toLocaleString()}</div>
                    <div class="stat-label">Ocorrências Registradas</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Embarcações</div>
                        <div class="stat-icon">
                            <i class="fas fa-ship"></i>
                        </div>
                    </div>
                    <div class="stat-value">${stats.embarcacoes.toLocaleString()}</div>
                    <div class="stat-label">Interceptadas</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Prisões</div>
                        <div class="stat-icon">
                            <i class="fas fa-handcuffs"></i>
                        </div>
                    </div>
                    <div class="stat-value">${stats.prisoes.toLocaleString()}</div>
                    <div class="stat-label">Efetuadas</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Furtos</div>
                        <div class="stat-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                    </div>
                    <div class="stat-value">${stats.furtos.toLocaleString()}</div>
                    <div class="stat-label">Registrados</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Gerências</div>
                        <div class="stat-icon">
                            <i class="fas fa-building"></i>
                        </div>
                    </div>
                    <div class="stat-value">${stats.gerencias}</div>
                    <div class="stat-label">Envolvidas</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Empresas</div>
                        <div class="stat-icon">
                            <i class="fas fa-industry"></i>
                        </div>
                    </div>
                    <div class="stat-value">${stats.empresas}</div>
                    <div class="stat-label">Afetadas</div>
                </div>
            `;
        }

        function calculateStats(data) {
            return {
                total: data.length,
                embarcacoes: data.reduce((sum, item) => sum + (parseInt(item['Embarcações Interceptadas']) || 0), 0),
                prisoes: data.reduce((sum, item) => sum + (parseInt(item['Quantitativo de Prisões']) || 0), 0),
                furtos: data.reduce((sum, item) => sum + (parseInt(item['Quantitativo de Furto']) || 0), 0),
                gerencias: new Set(data.map(item => item.Gerência).filter(Boolean)).size,
                empresas: new Set(data.map(item => item.Empresa).filter(Boolean)).size
            };
        }

        // ===== CRIAÇÃO DE GRÁFICOS =====
        function createCharts() {
            const container = document.getElementById('chartsContainer');
            container.innerHTML = '';
            
            // Destruir gráficos existentes
            Object.values(charts).forEach(chart => {
                try {
                    chart.destroy();
                } catch (e) {
                    console.warn('Erro ao destruir gráfico:', e);
                }
            });
            charts = {};
            
            if (filteredData.length === 0) {
                showEmptyState();
                return;
            }
            
            // Criar todos os gráficos com design moderno
            createComparativoAnual();
            createBroiPorGerencia();
            createBroiPorTipificacao();
            createBroiPorGradacao();
            createEmbarcacaoNaoAutorizada();
            createFiscalizacaoTransito();
            createAtendimentoSeguranca();
            createIncendio();
            createNeutralizacaoOcorrencia();
            createDanoMeioAmbiente();
            createAbandonoExtravio();
            createAcidenteTransito();
            createQuantitativoFurto();
            createQuantitativoPrisoes();
            createAtitudeInconveniente();
            createInvasaoFurtoNMP();
            createTiposDanoMeioAmbiente();
            createEmbarcacoesInterceptadas();
        }

        function createModernChart(id, type, title, icon, labels, datasets, options = {}) {
            const chartCard = document.createElement('div');
            chartCard.className = 'chart-card';
            chartCard.innerHTML = `
                <div class="chart-header">
                    <div class="chart-title">
                        <div class="chart-icon">
                            <i class="fas ${icon}"></i>
                        </div>
                        ${title}
                    </div>
                    <div class="chart-actions">
                        <button class="chart-btn" onclick="showTable('${id}', '${title}')" title="Ver dados">
                            <i class="fas fa-table"></i>
                        </button>
                        <button class="chart-btn" onclick="toggleChartType('${id}')" title="Alterar tipo">
                            <i class="fas fa-exchange-alt"></i>
                        </button>
                        <button class="chart-btn" onclick="exportChart('${id}')" title="Exportar">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
                <div class="chart-content">
                    <canvas id="chart-${id}" class="chart-canvas"></canvas>
                </div>
            `;
            
            document.getElementById('chartsContainer').appendChild(chartCard);
            
            if (labels.length === 0) {
                chartCard.querySelector('.chart-content').innerHTML = `
                    <div class="no-data">
                        <div class="no-data-icon">
                            <i class="fas ${icon}"></i>
                        </div>
                        <h3>Sem dados</h3>
                        <p>Nenhum registro encontrado para este período</p>
                    </div>
                `;
                return;
            }
            
            const ctx = document.getElementById(`chart-${id}`).getContext('2d');
            
            // Aplicar gradientes modernos aos datasets
            datasets.forEach((dataset, index) => {
                const gradientColors = gradients[Object.keys(gradients)[index % Object.keys(gradients).length]];
                
                if (type === 'line') {
                    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                    gradient.addColorStop(0, gradientColors[0] + '80');
                    gradient.addColorStop(1, gradientColors[1] + '20');
                    dataset.backgroundColor = gradient;
                    dataset.borderColor = gradientColors[0];
                    dataset.borderWidth = 3;
                    dataset.fill = true;
                    dataset.tension = 0.4;
                    dataset.pointBackgroundColor = gradientColors[0];
                    dataset.pointBorderColor = '#ffffff';
                    dataset.pointBorderWidth = 2;
                }
                
                if (type === 'bar') {
                    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                    gradient.addColorStop(0, gradientColors[0]);
                    gradient.addColorStop(1, gradientColors[1]);
                    dataset.backgroundColor = gradient;
                    dataset.borderColor = gradientColors[0];
                    dataset.borderWidth = 0;
                    dataset.borderRadius = 8;
                    dataset.borderSkipped = false;
                }
                
                if (type === 'doughnut' || type === 'pie') {
                    dataset.backgroundColor = labels.map((_, i) => {
                        const colorIndex = i % Object.keys(gradients).length;
                        const colors = gradients[Object.keys(gradients)[colorIndex]];
                        return colors[0];
                    });
                    dataset.borderColor = 'rgba(255, 255, 255, 0.2)';
                    dataset.borderWidth = 2;
                    dataset.hoverBorderColor = '#ffffff';
                    dataset.hoverBorderWidth = 3;
                }
            });
            
            const defaultOptions = {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 1500,
                    easing: 'easeInOutQuart'
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            font: {
                                size: 12,
                                weight: '500'
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: 'rgba(255, 255, 255, 0.2)',
                        borderWidth: 1,
                        cornerRadius: 12,
                        padding: 12,
                        titleFont: {
                            size: 14,
                            weight: '600'
                        },
                        bodyFont: {
                            size: 13,
                            weight: '500'
                        }
                    }
                },
                interaction: {
                    mode: 'index',
                    intersect: false
                }
            };
            
            if (type === 'bar' || type === 'line') {
                defaultOptions.scales = {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            font: {
                                size: 11,
                                weight: '500'
                            },
                            padding: 10
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: 11,
                                weight: '500'
                            },
                            maxRotation: 45,
                            padding: 10
                        }
                    }
                };
            }
            
            const finalOptions = { ...defaultOptions, ...options };
            
            try {
                charts[id] = new Chart(ctx, {
                    type,
                    data: { labels, datasets },
                    options: finalOptions
                });
                
                charts[id].chartData = { labels, datasets };
                charts[id].chartTitle = title;
                charts[id].originalType = type;
            } catch (error) {
                console.error(`Erro ao criar gráfico ${id}:`, error);
                chartCard.querySelector('.chart-content').innerHTML = `
                    <div class="no-data">
                        <div class="no-data-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3>Erro</h3>
                        <p>Não foi possível carregar este gráfico</p>
                    </div>
                `;
            }
        }

        // ===== IMPLEMENTAÇÃO DOS GRÁFICOS =====
        function createComparativoAnual() {
            const dadosPorAno = {};
            
            filteredData.forEach(item => {
                try {
                    const ano = new Date(item.Data).getFullYear();
                    const empresa = item.Empresa || item.O || 'Não Informada'; // Incluindo coluna O
                    
                    if (!dadosPorAno[ano]) dadosPorAno[ano] = {};
                    dadosPorAno[ano][empresa] = (dadosPorAno[ano][empresa] || 0) + 1;
                } catch (error) {
                    console.warn('Erro ao processar data:', item.Data, error);
                }
            });
            
            const anos = Object.keys(dadosPorAno).sort();
            // Incluir empresas tanto da coluna 'Empresa' quanto da coluna 'O'
            const empresas = [...new Set([
                ...filteredData.map(item => item.Empresa).filter(Boolean),
                ...filteredData.map(item => item.O).filter(Boolean)
            ])].slice(0, 10);
            
            const datasets = anos.map((ano, index) => ({
                label: ano,
                data: empresas.map(empresa => dadosPorAno[ano]?.[empresa] || 0)
            }));
            
            createModernChart(
                'comparativo-anual',
                'line',
                'Comparativo Anual BROI por Empresa',
                'fa-chart-line',
                empresas,
                datasets
            );
        }

        function createBroiPorGerencia() {
            const dados = {};
            filteredData.forEach(item => {
                const gerencia = item.Gerência || 'Não Informada';
                dados[gerencia] = (dados[gerencia] || 0) + 1;
            });
            
            const sortedData = Object.entries(dados)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);
            
            const labels = sortedData.map(item => item[0]);
            const values = sortedData.map(item => item[1]);
            
            createModernChart(
                'broi-gerencia',
                'doughnut',
                'BROI por Gerência',
                'fa-building',
                labels,
                [{
                    label: 'Ocorrências',
                    data: values
                }]
            );
        }

        function createBroiPorTipificacao() {
            const dados = {};
            filteredData.forEach(item => {
                const tipo = item.Tipificação || 'Não Informada';
                dados[tipo] = (dados[tipo] || 0) + 1;
            });
            
            const sortedData = Object.entries(dados)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 12);
            
            const labels = sortedData.map(item => item[0]);
            const values = sortedData.map(item => item[1]);
            
            createModernChart(
                'broi-tipificacao',
                'bar',
                'Top 12 BROI por Tipificação',
                'fa-list-alt',
                labels,
                [{
                    label: 'Ocorrências',
                    data: values
                }]
            );
        }

        function createBroiPorGradacao() {
            const dados = {};
            filteredData.forEach(item => {
                const gradacao = item.Gradação || 'Não Informada';
                dados[gradacao] = (dados[gradacao] || 0) + 1;
            });
            
            const labels = Object.keys(dados);
            const values = Object.values(dados);
            
            createModernChart(
                'broi-gradacao',
                'pie',
                'BROI por Gradação',
                'fa-chart-pie',
                labels,
                [{
                    label: 'Ocorrências',
                    data: values
                }]
            );
        }

        function createEmbarcacaoNaoAutorizada() {
            const dadosPorMes = processarDadosPorMes(
                filteredData.filter(item => 
                    item.Tipificação?.toLowerCase().includes('embarcação não autorizada')
                )
            );
            
            createModernChart(
                'embarcacao-nao-autorizada',
                'line',
                'Embarcação Não Autorizada',
                'fa-ship',
                dadosPorMes.labels,
                [{
                    label: 'Ocorrências',
                    data: dadosPorMes.values
                }]
            );
        }

        function createFiscalizacaoTransito() {
            const dadosPorMes = processarDadosPorMes(
                filteredData.filter(item => 
                    item.Tipificação?.toLowerCase().includes('fiscalização de trânsito')
                )
            );
            
            createModernChart(
                'fiscalizacao-transito',
                'bar',
                'Fiscalização de Trânsito',
                'fa-car',
                dadosPorMes.labels,
                [{
                    label: 'Ocorrências',
                    data: dadosPorMes.values
                }]
            );
        }

        function createAtendimentoSeguranca() {
            const dadosPorMes = processarDadosPorMes(
                filteredData.filter(item => 
                    item.Tipificação?.toLowerCase().includes('atendimento de segurança')
                )
            );
            
            createModernChart(
                'atendimento-seguranca',
                'line',
                'Atendimento de Segurança',
                'fa-shield-alt',
                dadosPorMes.labels,
                [{
                    label: 'Ocorrências',
                    data: dadosPorMes.values
                }]
            );
        }

        function createIncendio() {
            const dadosPorMes = processarDadosPorMes(
                filteredData.filter(item => 
                    item.Tipificação?.toLowerCase().includes('incêndio')
                )
            );
            
            createModernChart(
                'incendio',
                'bar',
                'Incêndio',
                'fa-fire',
                dadosPorMes.labels,
                [{
                    label: 'Ocorrências',
                    data: dadosPorMes.values
                }]
            );
        }

        function createNeutralizacaoOcorrencia() {
            const dadosPorMes = processarDadosPorMes(
                filteredData.filter(item => 
                    item.Tipificação?.toLowerCase().includes('neutralização')
                )
            );
            
            createModernChart(
                'neutralizacao-ocorrencia',
                'line',
                'Neutralização de Ocorrência',
                'fa-ban',
                dadosPorMes.labels,
                [{
                    label: 'Ocorrências',
                    data: dadosPorMes.values
                }]
            );
        }

        function createDanoMeioAmbiente() {
            const dadosPorMes = processarDadosPorMes(
                filteredData.filter(item => 
                    item.Tipificação?.toLowerCase().includes('dano ao meio ambiente')
                )
            );
            
            createModernChart(
                'dano-meio-ambiente',
                'bar',
                'Dano ao Meio Ambiente',
                'fa-leaf',
                dadosPorMes.labels,
                [{
                    label: 'Ocorrências',
                    data: dadosPorMes.values
                }]
            );
        }

        function createAbandonoExtravio() {
            const dadosPorMes = processarDadosPorMes(
                filteredData.filter(item => 
                    item.Tipificação?.toLowerCase().includes('abandono') || 
                    item.Tipificação?.toLowerCase().includes('extravio')
                )
            );
            
            createModernChart(
                'abandono-extravio',
                'line',
                'Abandono/Extravio',
                'fa-exclamation-triangle',
                dadosPorMes.labels,
                [{
                    label: 'Ocorrências',
                    data: dadosPorMes.values
                }]
            );
        }

        function createAcidenteTransito() {
            const dadosPorMes = processarDadosPorMes(
                filteredData.filter(item => 
                    item.Tipificação?.toLowerCase().includes('acidente de trânsito')
                )
            );
            
            createModernChart(
                'acidente-transito',
                'bar',
                'Acidente de Trânsito',
                'fa-car-crash',
                dadosPorMes.labels,
                [{
                    label: 'Ocorrências',
                    data: dadosPorMes.values
                }]
            );
        }

        function createQuantitativoFurto() {
            const dadosPorMes = {};
            filteredData.forEach(item => {
                try {
                    const data = new Date(item.Data);
                    const mesAno = `${data.getFullYear()}-${String(data.getMonth() + 1).padStart(2, '0')}`;
                    const furtos = parseInt(item['Quantitativo de Furto']) || 0;
                    dadosPorMes[mesAno] = (dadosPorMes[mesAno] || 0) + furtos;
                } catch (error) {
                    console.warn('Erro ao processar furto:', item, error);
                }
            });
            
            const labels = Object.keys(dadosPorMes).sort();
            const values = labels.map(label => dadosPorMes[label]);
            
            createModernChart(
                'quantitativo-furto',
                'bar',
                'Quantitativo de Furto',
                'fa-user-secret',
                labels,
                [{
                    label: 'Furtos',
                    data: values
                }]
            );
        }

        function createQuantitativoPrisoes() {
            const dadosPorMes = {};
            filteredData.forEach(item => {
                try {
                    const data = new Date(item.Data);
                    const mesAno = `${data.getFullYear()}-${String(data.getMonth() + 1).padStart(2, '0')}`;
                    const prisoes = parseInt(item['Quantitativo de Prisões']) || 0;
                    dadosPorMes[mesAno] = (dadosPorMes[mesAno] || 0) + prisoes;
                } catch (error) {
                    console.warn('Erro ao processar prisão:', item, error);
                }
            });
            
            const labels = Object.keys(dadosPorMes).sort();
            const values = labels.map(label => dadosPorMes[label]);
            
            createModernChart(
                'quantitativo-prisoes',
                'line',
                'Quantitativo de Prisões',
                'fa-handcuffs',
                labels,
                [{
                    label: 'Prisões',
                    data: values
                }]
            );
        }

        function createAtitudeInconveniente() {
            const dadosPorMes = processarDadosPorMes(
                filteredData.filter(item => 
                    item.Tipificação?.toLowerCase().includes('atitude inconveniente')
                )
            );
            
            createModernChart(
                'atitude-inconveniente',
                'bar',
                'Atitude Inconveniente',
                'fa-user-times',
                dadosPorMes.labels,
                [{
                    label: 'Ocorrências',
                    data: dadosPorMes.values
                }]
            );
        }

        function createInvasaoFurtoNMP() {
            const dadosPorMes = processarDadosPorMes(
                filteredData.filter(item => 
                    item.Tipificação?.toLowerCase().includes('invasão') && 
                    item.Tipificação?.toLowerCase().includes('furto')
                )
            );
            
            createModernChart(
                'invasao-furto-nmp',
                'line',
                'Invasão e Furto em NMP',
                'fa-home',
                dadosPorMes.labels,
                [{
                    label: 'Ocorrências',
                    data: dadosPorMes.values
                }]
            );
        }

        function createTiposDanoMeioAmbiente() {
            const tipos = {};
            filteredData
                .filter(item => item.Tipificação?.toLowerCase().includes('dano ao meio ambiente'))
                .forEach(item => {
                    const tipo = item.Tipificação || 'Não Especificado';
                    tipos[tipo] = (tipos[tipo] || 0) + 1;
                });
            
            const labels = Object.keys(tipos);
            const values = Object.values(tipos);
            
            createModernChart(
                'tipos-dano-meio-ambiente',
                'doughnut',
                'Tipos de Dano ao Meio Ambiente',
                'fa-tree',
                labels,
                [{
                    label: 'Ocorrências',
                    data: values
                }]
            );
        }

        function createEmbarcacoesInterceptadas() {
            const dadosPorMes = {};
            filteredData.forEach(item => {
                try {
                    const data = new Date(item.Data);
                    const mesAno = `${data.getFullYear()}-${String(data.getMonth() + 1).padStart(2, '0')}`;
                    const embarcacoes = parseInt(item['Embarcações Interceptadas']) || 0;
                    dadosPorMes[mesAno] = (dadosPorMes[mesAno] || 0) + embarcacoes;
                } catch (error) {
                    console.warn('Erro ao processar embarcação:', item, error);
                }
            });
            
            const labels = Object.keys(dadosPorMes).sort();
            const values = labels.map(label => dadosPorMes[label]);
            
            createModernChart(
                'embarcacoes-interceptadas',
                'line',
                'Embarcações Interceptadas',
                'fa-anchor',
                labels,
                [{
                    label: 'Embarcações',
                    data: values
                }]
            );
        }

        // ===== UTILITÁRIOS PARA GRÁFICOS =====
        function processarDadosPorMes(data) {
            const dadosPorMes = {};
            
            data.forEach(item => {
                try {
                    const itemDate = new Date(item.Data);
                    const mesAno = `${itemDate.getFullYear()}-${String(itemDate.getMonth() + 1).padStart(2, '0')}`;
                    dadosPorMes[mesAno] = (dadosPorMes[mesAno] || 0) + 1;
                } catch (error) {
                    console.warn('Erro ao processar data:', item.Data, error);
                }
            });
            
            const labels = Object.keys(dadosPorMes).sort();
            const values = labels.map(label => dadosPorMes[label]);
            
            return { labels, values };
        }

        function showEmptyState() {
            document.getElementById('chartsContainer').innerHTML = `
                <div class="chart-card">
                    <div class="chart-content">
                        <div class="no-data">
                            <div class="no-data-icon">
                                <i class="fas fa-search"></i>
                            </div>
                            <h3>Nenhum dado encontrado</h3>
                            <p>Ajuste os filtros para visualizar os gráficos</p>
                            <button class="btn btn-primary" onclick="clearFilters()" style="margin-top: 1rem;">
                                <i class="fas fa-eraser"></i>
                                Limpar Filtros
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function showErrorState() {
            document.getElementById('chartsContainer').innerHTML = `
                <div class="chart-card">
                    <div class="chart-content">
                        <div class="no-data">
                            <div class="no-data-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <h3>Erro ao carregar dados</h3>
                            <p>Verifique sua conexão e tente novamente</p>
                            <button class="btn btn-primary" onclick="refreshData()" style="margin-top: 1rem;">
                                <i class="fas fa-sync-alt"></i>
                                Tentar Novamente
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ===== FUNCIONALIDADES DOS GRÁFICOS =====
        function showTable(chartId, title) {
            const chart = charts[chartId];
            if (!chart) return;
            
            const { labels, datasets } = chart.chartData;
            let tableHTML = `
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Categoria</th>
                                ${datasets.map(ds => `<th>${ds.label}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${labels.map((label, i) => `
                                <tr>
                                    <td>${label}</td>
                                    ${datasets.map(ds => `<td>${(ds.data[i] || 0).toLocaleString()}</td>`).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = tableHTML;
            document.getElementById('modal').classList.remove('hidden');
        }

        function toggleChartType(chartId) {
            const chart = charts[chartId];
            if (!chart) return;
            
            const typeMap = {
                'bar': 'line',
                'line': 'bar',
                'pie': 'doughnut',
                'doughnut': 'pie'
            };
            
            const currentType = chart.config.type;
            const newType = typeMap[currentType] || 'bar';
            
            // Destruir e recriar com novo tipo
            const { labels, datasets } = chart.chartData;
            const title = chart.chartTitle;
            const canvas = chart.canvas;
            const chartCard = canvas.closest('.chart-card');
            
            chart.destroy();
            
            // Recriar com novo tipo
            const ctx = canvas.getContext('2d');
            
            try {
                charts[chartId] = new Chart(ctx, {
                    type: newType,
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: 800 },
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
                
                charts[chartId].chartData = { labels, datasets };
                charts[chartId].chartTitle = title;
                charts[chartId].originalType = chart.originalType;
                
                showToast(`Gráfico alterado para ${newType}`, 'success');
            } catch (error) {
                console.error('Erro ao alterar tipo do gráfico:', error);
                showToast('Erro ao alterar tipo do gráfico', 'error');
            }
        }

        function exportChart(chartId) {
            const chart = charts[chartId];
            if (!chart) return;
            
            try {
                const url = chart.toBase64Image('image/png', 1.0);
                const link = document.createElement('a');
                link.download = `${chartId}-${new Date().toISOString().split('T')[0]}.png`;
                link.href = url;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast('Gráfico exportado com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao exportar gráfico:', error);
                showToast('Erro ao exportar gráfico', 'error');
            }
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        // ===== EXPORTAÇÃO =====
        function exportCSV() {
            if (filteredData.length === 0) {
                showToast('Nenhum dado para exportar', 'warning');
                return;
            }
            
            try {
                const headers = Object.keys(filteredData[0]);
                let csv = '\uFEFF' + headers.join(',') + '\n'; // BOM para UTF-8
                
                filteredData.forEach(row => {
                    const values = headers.map(header => {
                        const value = row[header] || '';
                        return `"${String(value).replace(/"/g, '""')}"`;
                    });
                    csv += values.join(',') + '\n';
                });
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `broi-analytics-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast('Dados exportados para CSV!', 'success');
            } catch (error) {
                console.error('Erro ao exportar CSV:', error);
                showToast('Erro ao exportar CSV', 'error');
            }
        }

        function exportPDF() {
            if (filteredData.length === 0) {
                showToast('Nenhum dado para exportar', 'warning');
                return;
            }
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Cabeçalho
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text('BROI Analytics - Relatório Executivo', 14, 25);
                
                // Informações do relatório
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                const dataInicio = document.getElementById('dataInicio').value;
                const dataFim = document.getElementById('dataFim').value;
                const agora = new Date().toLocaleDateString('pt-BR');
                
                doc.text(`Período de análise: ${dataInicio} até ${dataFim}`, 14, 35);
                doc.text(`Total de registros: ${filteredData.length.toLocaleString()}`, 14, 42);
                doc.text(`Relatório gerado em: ${agora}`, 14, 49);
                
                // Linha separadora
                doc.setLineWidth(0.5);
                doc.line(14, 55, 196, 55);
                
                // Estatísticas resumo
                const stats = calculateStats(filteredData);
                let yPos = 65;
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('Resumo Executivo', 14, yPos);
                
                yPos += 10;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                
                const resumoData = [
                    ['Métrica', 'Valor'],
                    ['Total de Ocorrências', stats.total.toLocaleString()],
                    ['Embarcações Interceptadas', stats.embarcacoes.toLocaleString()],
                    ['Prisões Efetuadas', stats.prisoes.toLocaleString()],
                    ['Furtos Registrados', stats.furtos.toLocaleString()],
                    ['Gerências Envolvidas', stats.gerencias.toString()],
                    ['Empresas Afetadas', stats.empresas.toString()]
                ];
                
                doc.autoTable({
                    head: [resumoData[0]],
                    body: resumoData.slice(1),
                    startY: yPos,
                    styles: { 
                        fontSize: 9,
                        cellPadding: 3
                    },
                    headStyles: {
                        fillColor: [30, 58, 95],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [245, 245, 245]
                    }
                });
                
                // Análise por período
                yPos = doc.lastAutoTable.finalY + 15;
                
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('Análise Temporal', 14, yPos);
                
                // Dados por mês
                const dadosPorMes = {};
                filteredData.forEach(item => {
                    try {
                        const data = new Date(item.Data);
                        const mesAno = `${data.getFullYear()}-${String(data.getMonth() + 1).padStart(2, '0')}`;
                        dadosPorMes[mesAno] = (dadosPorMes[mesAno] || 0) + 1;
                    } catch (error) {
                        console.warn('Erro ao processar data para PDF:', item.Data);
                    }
                });
                
                const mesesData = [['Mês/Ano', 'Ocorrências']];
                Object.entries(dadosPorMes)
                    .sort(([a], [b]) => a.localeCompare(b))
                    .forEach(([mes, qtd]) => {
                        mesesData.push([mes, qtd.toString()]);
                    });
                
                doc.autoTable({
                    head: [mesesData[0]],
                    body: mesesData.slice(1),
                    startY: yPos + 8,
                    styles: { 
                        fontSize: 8,
                        cellPadding: 2
                    },
                    headStyles: {
                        fillColor: [30, 58, 95],
                        textColor: [255, 255, 255]
                    }
                });
                
                // Salvar PDF
                doc.save(`broi-analytics-relatorio-${new Date().toISOString().split('T')[0]}.pdf`);
                showToast('Relatório PDF gerado com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                showToast('Erro ao gerar relatório PDF', 'error');
            }
        }

        // Configuração de endpoints de API
        const endpoints = {
            main: '/exec',
            backup: '/dev',
            test: '/test'
        };

        // ===== FUNÇÕES AUXILIARES =====
        function clearFilters() {
            document.getElementById('gerenciaFilter').value = '';
            document.getElementById('empresaFilter').value = '';
            document.getElementById('tipificacaoFilter').value = '';
            setupDates();
            applyFilters();
            showToast('Filtros limpos', 'info');
        }

        // ===== LOG DE INICIALIZAÇÃO =====
        console.log('🚀 BROI Analytics Dashboard inicializado');
        console.log('⌨️  Atalhos disponíveis:');
        console.log('   Ctrl/Cmd + R: Atualizar dados');
        console.log('   Ctrl/Cmd + E: Exportar CSV');
        console.log('   Ctrl/Cmd + P: Gerar PDF');
        console.log('   ESC: Fechar modal');
    </script>
</body>
</html>
