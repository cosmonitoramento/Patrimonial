
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICE Analytics Platform | Enterprise Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --primary-color: #1e40af;
            --secondary-color: #64748b;
            --accent-color: #0ea5e9;
            --success-color: #059669;
            --warning-color: #d97706;
            --danger-color: #dc2626;
            --light-bg: #f8fafc;
            --dark-bg: #0f172a;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Header Styles */
        .main-header {
            background: linear-gradient(135deg, var(--dark-bg) 0%, #1e293b 100%);
            padding: 1.5rem 0;
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .logo-text h1 {
            color: white;
            font-size: 1.75rem;
            font-weight: 700;
            margin: 0;
            letter-spacing: -0.5px;
        }

        .logo-text p {
            color: #94a3b8;
            font-size: 0.875rem;
            margin: 0;
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--success-color);
            font-weight: 500;
            font-size: 0.875rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--success-color);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .refresh-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .refresh-btn:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Control Panel */
        .control-panel {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .control-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .control-header h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .control-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            align-items: end;
        }

        .form-group label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            display: block;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-control, .form-select {
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 0.875rem;
            font-weight: 500;
            transition: all 0.3s ease;
            background: white;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
            outline: none;
        }

        .filter-info {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            padding: 1rem;
            border-radius: 12px;
            margin-top: 1rem;
            font-weight: 600;
            display: none;
        }

        /* KPI Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
        }

        .kpi-card.danger::before { background: linear-gradient(90deg, var(--danger-color), #ef4444); }
        .kpi-card.success::before { background: linear-gradient(90deg, var(--success-color), #10b981); }
        .kpi-card.warning::before { background: linear-gradient(90deg, var(--warning-color), #f59e0b); }
        .kpi-card.info::before { background: linear-gradient(90deg, var(--accent-color), #06b6d4); }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .kpi-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 0;
        }

        .kpi-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            background: var(--light-bg);
            color: var(--primary-color);
        }

        .kpi-card.danger .kpi-icon { background: #fef2f2; color: var(--danger-color); }
        .kpi-card.success .kpi-icon { background: #f0fdf4; color: var(--success-color); }
        .kpi-card.warning .kpi-icon { background: #fffbeb; color: var(--warning-color); }
        .kpi-card.info .kpi-icon { background: #f0f9ff; color: var(--accent-color); }

        .kpi-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            line-height: 1;
            font-variant-numeric: tabular-nums;
        }

        .kpi-trend {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .trend-up { color: var(--success-color); }
        .trend-down { color: var(--danger-color); }
        .trend-neutral { color: var(--text-secondary); }

        /* Chart Container */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .chart-card:hover {
            box-shadow: var(--shadow-lg);
        }

        .chart-header {
            background: linear-gradient(135deg, var(--dark-bg), #1e293b);
            color: white;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .chart-header h4 {
            font-size: 1rem;
            font-weight: 600;
            margin: 0;
            flex-grow: 1;
        }

        .chart-header-icon {
            width: 36px;
            height: 36px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chart-body {
            padding: 2rem;
        }

        .chart-container {
            position: relative;
            height: 350px;
        }

        .chart-container.large {
            height: 450px;
        }

        .chart-full-width {
            grid-column: 1 / -1;
        }

        /* Loading States */
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 300px;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .control-grid {
                grid-template-columns: 1fr;
            }
            
            .kpi-grid {
                grid-template-columns: 1fr;
            }
            
            .main-content {
                padding: 1rem;
            }
            
            .logo-text h1 {
                font-size: 1.5rem;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            :root {
                --light-bg: #1e293b;
                --card-bg: #334155;
                --border-color: #475569;
                --text-primary: #f1f5f9;
                --text-secondary: #cbd5e1;
            }
        }

        /* Print styles */
        @media print {
            .header-actions, .control-panel { display: none; }
            .chart-card { break-inside: avoid; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="main-header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-icon">
                    <i class="fas fa-chart-network"></i>
                </div>
                <div class="logo-text">
                    <h1>ICE Analytics</h1>
                    <p>Enterprise Control Dashboard</p>
                </div>
            </div>
            <div class="header-actions">
                <div class="status-indicator">
                    <span class="status-dot"></span>
                    Sistema Online
                </div>
                <button class="refresh-btn" onclick="atualizarDashboard()">
                    <i class="fas fa-sync-alt"></i>
                    Atualizar
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Control Panel -->
        <section class="control-panel fade-in">
            <div class="control-header">
                <div class="control-icon">
                    <i class="fas fa-filter"></i>
                </div>
                <h3>Controle de Filtros</h3>
            </div>
            <div class="control-grid">
                <div class="form-group">
                    <label for="filtro_periodo">Período de Análise</label>
                    <select id="filtro_periodo" class="form-select">
                        <option value="todos">Todos os períodos</option>
                        <option value="hoje">Hoje</option>
                        <option value="7dias">Últimos 7 dias</option>
                        <option value="30dias">Últimos 30 dias</option>
                        <option value="90dias">Últimos 90 dias</option>
                        <option value="personalizado">Período personalizado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="data_inicio">Data de Início</label>
                    <input type="date" id="data_inicio" class="form-control" style="display: none;">
                </div>
                <div class="form-group">
                    <label for="data_fim">Data Final</label>
                    <input type="date" id="data_fim" class="form-control" style="display: none;">
                </div>
            </div>
            
            <div id="filtro_info" class="filter-info">
                <i class="fas fa-info-circle"></i>
                <span id="filtro_texto">Filtro ativo</span>
            </div>
        </section>

        <!-- KPI Cards -->
        <section class="kpi-grid fade-in">
            <div class="kpi-card">
                <div class="kpi-header">
                    <h3 class="kpi-title">Total de ICEs</h3>
                    <div class="kpi-icon">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                </div>
                <div class="kpi-value" id="total_ices">0</div>
                <div class="kpi-trend trend-neutral">
                    <i class="fas fa-minus"></i>
                    Sem variação
                </div>
            </div>

            <div class="kpi-card danger">
                <div class="kpi-header">
                    <h3 class="kpi-title">Acionamentos Reais</h3>
                    <div class="kpi-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                </div>
                <div class="kpi-value" id="acionamentos_reais">0</div>
                <div class="kpi-trend trend-neutral">
                    <i class="fas fa-minus"></i>
                    Crítico
                </div>
            </div>

            <div class="kpi-card info">
                <div class="kpi-header">
                    <h3 class="kpi-title">Simulados</h3>
                    <div class="kpi-icon">
                        <i class="fas fa-play-circle"></i>
                    </div>
                </div>
                <div class="kpi-value" id="simulados">0</div>
                <div class="kpi-trend trend-up">
                    <i class="fas fa-arrow-up"></i>
                    Treinamento
                </div>
            </div>

            <div class="kpi-card success">
                <div class="kpi-header">
                    <h3 class="kpi-title">Taxa Real</h3>
                    <div class="kpi-icon">
                        <i class="fas fa-percentage"></i>
                    </div>
                </div>
                <div class="kpi-value" id="taxa_real">0%</div>
                <div class="kpi-trend trend-neutral">
                    <i class="fas fa-minus"></i>
                    Monitorando
                </div>
            </div>

            <div class="kpi-card warning">
                <div class="kpi-header">
                    <h3 class="kpi-title">Total BCs</h3>
                    <div class="kpi-icon">
                        <i class="fas fa-broadcast-tower"></i>
                    </div>
                </div>
                <div class="kpi-value" id="total_bcs">0</div>
                <div class="kpi-trend trend-neutral">
                    <i class="fas fa-minus"></i>
                    Comunicações
                </div>
            </div>
        </section>

        <!-- Charts Grid -->
        <section class="charts-grid fade-in">
            <!-- Comparativo Anual -->
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-header-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h4>Comparativo ICE 2024 vs 2025</h4>
                </div>
                <div class="chart-body">
                    <div class="chart-container">
                        <canvas id="chart_comparativo_anos"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tipificação por Mês -->
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-header-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <h4>Tipificação por Mês - 2025</h4>
                </div>
                <div class="chart-body">
                    <div class="chart-container">
                        <canvas id="chart_tipificacao_por_mes"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tipificação Mês Atual -->
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-header-icon">
                        <i class="fas fa-tags"></i>
                    </div>
                    <h4>Tipificação - Mês Atual</h4>
                </div>
                <div class="chart-body">
                    <div class="chart-container">
                        <canvas id="chart_tipificacao_mes"></canvas>
                    </div>
                </div>
            </div>

            <!-- BCs por Mês -->
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-header-icon">
                        <i class="fas fa-broadcast-tower"></i>
                    </div>
                    <h4>BCs por Mês</h4>
                </div>
                <div class="chart-body">
                    <div class="chart-container">
                        <canvas id="chart_bcs_mes"></canvas>
                    </div>
                </div>
            </div>

            <!-- Gerências Mês Atual -->
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-header-icon">
                        <i class="fas fa-building"></i>
                    </div>
                    <h4>Gerências - Mês Atual</h4>
                </div>
                <div class="chart-body">
                    <div class="chart-container">
                        <canvas id="chart_gerencia_mes"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tipificação Anual -->
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-header-icon">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                    <h4>Tipificação - Ano Atual</h4>
                </div>
                <div class="chart-body">
                    <div class="chart-container">
                        <canvas id="chart_tipificacao_anual"></canvas>
                    </div>
                </div>
            </div>

            <!-- Gerências Anual -->
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-header-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <h4>Gerências - Ano Atual</h4>
                </div>
                <div class="chart-body">
                    <div class="chart-container">
                        <canvas id="chart_gerencia_anual"></canvas>
                    </div>
                </div>
            </div>

            <!-- BCs Comparativo -->
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-header-icon">
                        <i class="fas fa-signal"></i>
                    </div>
                    <h4>BCs Comparativo 2024 vs 2025</h4>
                </div>
                <div class="chart-body">
                    <div class="chart-container">
                        <canvas id="chart_bcs_comparativo"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Evolução Mensal - Full Width -->
        <section class="charts-grid fade-in">
            <div class="chart-card chart-full-width">
                <div class="chart-header">
                    <div class="chart-header-icon">
                        <i class="fas fa-chart-area"></i>
                    </div>
                    <h4>Evolução Mensal Completa - 2025</h4>
                </div>
                <div class="chart-body">
                    <div class="chart-container large">
                        <canvas id="chart_evolucao_mensal"></canvas>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <!-- Scripts modernizados (mantendo a lógica original) -->

    // --- Configurações e Variáveis Globais ---
<script>  
    const API_URL = 'https://script.google.com/macros/s/AKfycbwlmRP4hZwVhPt36QtLs2MJ2ow76Xx3kTvMm6O4Pkf0R_rNCgMsVXQtu0UuEMaHK0zpNw/exec';
    let dadosIce = [];
    const charts = {};
    const chartIds = [
        'chart_comparativo_anos', 'chart_tipificacao_mes', 'chart_tipificacao_por_mes',
        'chart_bcs_mes', 'chart_gerencia_mes', 'chart_tipificacao_anual',
        'chart_gerencia_anual', 'chart_bcs_comparativo', 'chart_evolucao_mensal'
    ];
    const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
    
    // --- Funções da API e Utilitários ---
    async function callAPI(method, action, data = null) {
        document.querySelectorAll('.shimmer').forEach(el => el.classList.add('shimmer'));
        try {
            console.log(`Chamando API: ${method} ${action}`);
            const url = new URL(API_URL);
            let response;
            if (method === 'GET') {
                url.searchParams.append('action', action);
                if (data) {
                    Object.keys(data).forEach(key => url.searchParams.append(key, data[key]));
                }
                response = await fetch(url);
            } else {
                data = data || {};
                data.action = action;
                response = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: new URLSearchParams(data)
                });
            }

            if (!response.ok) {
                throw new Error(`Erro na rede: ${response.statusText}`);
            }

            const result = await response.json();
            document.querySelectorAll('.shimmer').forEach(el => el.classList.remove('shimmer'));
            return result;
        } catch (error) {
            console.error('Erro na API:', error);
            document.querySelectorAll('.shimmer').forEach(el => el.classList.remove('shimmer'));
            mostrarErro('Erro de conexão ou dados inválidos: ' + error.message);
            return { status: 'error', message: 'Erro de conexão ou dados inválidos: ' + error.message };
        }
    }

    function mostrarErro(mensagem) {
        let errorMsg = document.querySelector('.error-message');
        if (errorMsg) errorMsg.remove();
        errorMsg = document.createElement('div');
        errorMsg.className = 'error-message fade-in';
        errorMsg.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${mensagem}`;
        const header = document.querySelector('.header');
        header.parentNode.insertBefore(errorMsg, header.nextSibling);
        setTimeout(() => {
            errorMsg.style.opacity = '0';
            setTimeout(() => errorMsg.remove(), 300);
        }, 5000);
    }

    function parseDate(dateString) {
        if (!dateString) return null;
        let date = null;
        if (dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
            date = new Date(dateString + 'T00:00:00');
        } else if (dateString.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
            const [day, month, year] = dateString.split('/');
            date = new Date(year, month - 1, day);
        } else {
            date = new Date(dateString);
        }
        if (isNaN(date.getTime())) {
            console.warn('Data inválida:', dateString);
            return null;
        }
        return date;
    }

    function isDateInRange(dateString, startDate, endDate) {
        const date = parseDate(dateString);
        if (!date) return false;
        const normalizedDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        const normalizedStart = startDate ? new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate()) : null;
        const normalizedEnd = endDate ? new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate()) : null;
        if (normalizedStart && normalizedDate < normalizedStart) return false;
        if (normalizedEnd && normalizedDate > normalizedEnd) return false;
        return true;
    }

    function getDateInfo(dateString) {
        const date = parseDate(dateString);
        if (!date) return null;
        return {
            year: date.getFullYear(),
            month: date.getMonth(),
            fullDate: date
        };
    }

    // --- Lógica de Filtros ---
    function filtrarDadosPorPeriodo() {
        const periodo = document.getElementById('filtro_periodo').value;
        const dataInicio = document.getElementById('data_inicio').value;
        const dataFim = document.getElementById('data_fim').value;
        let dadosFiltrados = [...dadosIce];
        let textoFiltro = '';
        
        if (periodo === 'todos') {
            textoFiltro = 'Exibindo todos os períodos';
        } else {
            const hoje = new Date();
            hoje.setHours(23, 59, 59, 999);
            let dataLimite = null;
            
            switch (periodo) {
                case 'hoje':
                    dataLimite = new Date();
                    dataLimite.setHours(0, 0, 0, 0);
                    dadosFiltrados = dadosIce.filter(ice => isDateInRange(ice.data, dataLimite, hoje));
                    textoFiltro = `Filtro: Hoje (${dataLimite.toLocaleDateString('pt-BR')})`;
                    break;
                case '7dias':
                    dataLimite = new Date();
                    dataLimite.setDate(hoje.getDate() - 7);
                    dataLimite.setHours(0, 0, 0, 0);
                    dadosFiltrados = dadosIce.filter(ice => isDateInRange(ice.data, dataLimite, hoje));
                    textoFiltro = `Filtro: Últimos 7 dias`;
                    break;
                case '30dias':
                    dataLimite = new Date();
                    dataLimite.setDate(hoje.getDate() - 30);
                    dataLimite.setHours(0, 0, 0, 0);
                    dadosFiltrados = dadosIce.filter(ice => isDateInRange(ice.data, dataLimite, hoje));
                    textoFiltro = `Filtro: Últimos 30 dias`;
                    break;
                case '90dias':
                    dataLimite = new Date();
                    dataLimite.setDate(hoje.getDate() - 90);
                    dataLimite.setHours(0, 0, 0, 0);
                    dadosFiltrados = dadosIce.filter(ice => isDateInRange(ice.data, dataLimite, hoje));
                    textoFiltro = `Filtro: Últimos 90 dias`;
                    break;
                case 'personalizado':
                    if (dataInicio && dataFim) {
                        const inicio = parseDate(dataInicio);
                        const fim = parseDate(dataFim);
                        if (inicio && fim) {
                            fim.setHours(23, 59, 59, 999);
                            dadosFiltrados = dadosIce.filter(ice => isDateInRange(ice.data, inicio, fim));
                            textoFiltro = `Filtro: ${inicio.toLocaleDateString('pt-BR')} - ${fim.toLocaleDateString('pt-BR')}`;
                        } else {
                            textoFiltro = 'Filtro personalizado: Selecione datas válidas';
                        }
                    } else {
                        textoFiltro = 'Filtro personalizado: Selecione as datas';
                    }
                    break;
            }
        }
        
        const filtroInfo = document.getElementById('filtro_info');
        const filtroTexto = document.getElementById('filtro_texto');
        
        if (filtroInfo && filtroTexto) {
            if (periodo === 'todos') {
                filtroInfo.style.display = 'none';
            } else {
                filtroInfo.style.display = 'block';
                filtroTexto.textContent = `${textoFiltro} - ${dadosFiltrados.length} registros encontrados`;
            }
        }

        return dadosFiltrados;
    }

    // --- Funções de Gráficos ---
    function destruirGrafico(chartKey) {
        if (charts[chartKey]) {
            try {
                charts[chartKey].destroy();
                charts[chartKey] = null;
            } catch (error) {
                console.warn(`Erro ao destruir gráfico ${chartKey}:`, error);
            }
        }
    }

    function criarGraficoVazio(canvasId, chartKey, title = 'Sem dados') {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        destruirGrafico(chartKey);
        const ctx = canvas.getContext('2d');
        if (!ctx) return;
        charts[chartKey] = new Chart(ctx, {
            type: 'bar',
            data: { labels: ['Sem dados'], datasets: [{ label: title, data: [0], backgroundColor: '#E5E5E5' }] },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } },
                plugins: { legend: { display: false }, title: { display: true, text: title } }
            }
        });
    }

    function criarTodosGraficosVazios() {
        chartIds.forEach(id => {
            const chartKey = id.replace('chart_', '');
            criarGraficoVazio(id, chartKey, 'Sem dados disponíveis');
        });
    }

    function atualizarGraficoComparativoAnos(dados) {
        const canvas = document.getElementById('chart_comparativo_anos');
        if (!canvas) {
            console.error('Canvas "chart_comparativo_anos" não encontrado.');
            return;
        }

        const dados2024 = new Array(12).fill(0);
        const dados2025 = new Array(12).fill(0);
        
        dados.forEach(ice => {
            const dateInfo = getDateInfo(ice.data);
            if (!dateInfo) return;
            const { year, month } = dateInfo;
            if (year === 2024) dados2024[month]++;
            else if (year === 2025) dados2025[month]++;
        });
        
        const chartKey = 'comparativoAnos';
        destruirGrafico(chartKey);

        charts[chartKey] = new Chart(canvas.getContext('2d'), {
            type: 'line',
            data: {
                labels: months,
                datasets: [
                    { label: '2024', data: dados2024, borderColor: 'rgba(74, 124, 89, 1)', backgroundColor: 'rgba(74, 124, 89, 0.1)', tension: 0.4, fill: true, borderWidth: 3, pointBackgroundColor: 'rgba(74, 124, 89, 1)', pointRadius: 4, pointHoverRadius: 6 },
                    { label: '2025', data: dados2025, borderColor: 'rgba(44, 85, 48, 1)', backgroundColor: 'rgba(44, 85, 48, 0.1)', tension: 0.4, fill: true, borderWidth: 3, pointBackgroundColor: 'rgba(44, 85, 48, 1)', pointRadius: 4, pointHoverRadius: 6 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1, font: { size: 11, weight: '500' } }, grid: { color: 'rgba(0, 0, 0, 0.05)' } },
                    x: { ticks: { font: { size: 11, weight: '500' } }, grid: { color: 'rgba(0, 0, 0, 0.05)' } }
                },
                plugins: { legend: { position: 'top', labels: { usePointStyle: true, boxWidth: 10, padding: 15, font: { size: 11, weight: '600' } } } },
                interaction: { mode: 'index', intersect: false },
                animation: { duration: 1000, easing: 'easeOutQuart' }
            }
        });
    }

    function atualizarGraficoTipificacaoMes(dados) {
        const canvas = document.getElementById('chart_tipificacao_mes');
        if (!canvas) {
            console.error('Canvas "chart_tipificacao_mes" não encontrado.');
            return;
        }

        const agora = new Date();
        const mesAtual = agora.getMonth();
        const anoAtual = agora.getFullYear();
        const dadosMes = dados.filter(ice => {
            const dateInfo = getDateInfo(ice.data);
            if (!dateInfo) return false;
            return dateInfo.month === mesAtual && dateInfo.year === anoAtual;
        });

        const contagem = {};
        dadosMes.forEach(ice => {
            const tip = ice.tipificacao || 'Não informado';
            contagem[tip] = (contagem[tip] || 0) + 1;
        });

        const labels = Object.keys(contagem);
        const values = Object.values(contagem);

        const chartKey = 'tipificacaoMes';
        destruirGrafico(chartKey);

        if (labels.length === 0) {
            criarGraficoVazio('chart_tipificacao_mes', chartKey, 'Sem dados para o mês atual');
            return;
        }

        charts[chartKey] = new Chart(canvas.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: ['#4a7c59', '#6b8e5a', '#8fa85c', '#b3c25e', '#d7dc60', '#fbf662', '#f4d03f', '#f7dc6f'],
                    borderWidth: 2, borderColor: '#fff'
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { padding: 20, font: { size: 11, weight: '500' } } } },
                animation: { animateRotate: true, animateScale: true, duration: 1000, easing: 'easeOutQuart' },
                cutout: '60%'
            }
        });
    }

    function atualizarGraficoTipificacaoPorMes(dados) {
        const canvas = document.getElementById('chart_tipificacao_por_mes');
        if (!canvas) {
            console.error('Canvas "chart_tipificacao_por_mes" não encontrado.');
            return;
        }
        
        const contagem = {};
        dados.forEach(ice => {
            const dateInfo = getDateInfo(ice.data);
            if (!dateInfo) return;
            const mesAno = `${months[dateInfo.month]}/${dateInfo.year}`;
            const tip = ice.tipificacao || 'Não informado';
            if (!contagem[mesAno]) contagem[mesAno] = {};
            contagem[mesAno][tip] = (contagem[mesAno][tip] || 0) + 1;
        });
        
        const labels = Object.keys(contagem).sort((a, b) => {
            const [mesA, anoA] = a.split('/');
            const [mesB, anoB] = b.split('/');
            const dateA = new Date(`${anoA}-${months.indexOf(mesA) + 1}-01`);
            const dateB = new Date(`${anoB}-${months.indexOf(mesB) + 1}-01`);
            return dateA - dateB;
        });
        
        const allTipificacoes = [...new Set(dados.map(ice => ice.tipificacao).filter(Boolean))].sort();
        
        const datasets = allTipificacoes.map((tip, index) => {
            const color = `hsl(${(index * 50) % 360}, 70%, 50%)`;
            return {
                label: tip,
                data: labels.map(mesAno => contagem[mesAno][tip] || 0),
                backgroundColor: color,
            };
        });

        const chartKey = 'tipificacaoPorMes';
        destruirGrafico(chartKey);

        if (labels.length === 0) {
            criarGraficoVazio('chart_tipificacao_por_mes', chartKey, 'Sem dados para o período');
            return;
        }

        charts[chartKey] = new Chart(canvas.getContext('2d'), {
            type: 'bar',
            data: { labels, datasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { stacked: true },
                    y: { stacked: true, beginAtZero: true }
                },
                plugins: { legend: { position: 'top' }, title: { display: true, text: 'Tipificação por Mês' } }
            }
        });
    }

    function atualizarGraficoEvolucaoMensal(dados) {
        const canvas = document.getElementById('chart_evolucao_mensal');
        if (!canvas) {
            console.error('Canvas "chart_evolucao_mensal" não encontrado.');
            return;
        }

        const contagem = {};
        dados.forEach(ice => {
            const dateInfo = getDateInfo(ice.data);
            if (!dateInfo) return;
            const mesAno = `${months[dateInfo.month]}/${dateInfo.year}`;
            contagem[mesAno] = (contagem[mesAno] || 0) + 1;
        });
        
        const labels = Object.keys(contagem).sort((a, b) => {
            const [mesA, anoA] = a.split('/');
            const [mesB, anoB] = b.split('/');
            const dateA = new Date(`${anoA}-${months.indexOf(mesA) + 1}-01`);
            const dateB = new Date(`${anoB}-${months.indexOf(mesB) + 1}-01`);
            return dateA - dateB;
        });
        const values = labels.map(mesAno => contagem[mesAno]);
        
        const chartKey = 'evolucaoMensal';
        destruirGrafico(chartKey);

        if (labels.length === 0) {
            criarGraficoVazio('chart_evolucao_mensal', chartKey, 'Sem dados para o período');
            return;
        }

        charts[chartKey] = new Chart(canvas.getContext('2d'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Número de ICEs',
                    data: values,
                    borderColor: '#4a7c59',
                    backgroundColor: 'rgba(74, 124, 89, 0.2)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                plugins: { title: { display: true, text: 'Evolução Mensal de ICEs' } }
            }
        });
    }

    function atualizarGraficoBcsMes(dados) {
        const canvas = document.getElementById('chart_bcs_mes');
        if (!canvas) {
            console.error('Canvas "chart_bcs_mes" não encontrado.');
            return;
        }

        const agora = new Date();
        const mesAtual = agora.getMonth();
        const anoAtual = agora.getFullYear();
        const dadosMes = dados.filter(ice => {
            const dateInfo = getDateInfo(ice.data);
            if (!dateInfo) return false;
            return dateInfo.month === mesAtual && dateInfo.year === anoAtual;
        });

        const contagem = {};
        dadosMes.forEach(ice => {
            const tip = ice.tipificacao || 'Não informado';
            contagem[tip] = (contagem[tip] || 0) + (parseInt(ice.quantidade_bcs) || 0);
        });

        const labels = Object.keys(contagem);
        const values = Object.values(contagem);

        const chartKey = 'bcsMes';
        destruirGrafico(chartKey);

        if (labels.length === 0) {
            criarGraficoVazio('chart_bcs_mes', chartKey, 'Sem dados para o mês atual');
            return;
        }

        charts[chartKey] = new Chart(canvas.getContext('2d'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Total de BCS',
                    data: values,
                    backgroundColor: '#007bff',
                    borderColor: '#007bff',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1 } },
                },
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: 'BCS por Mês' }
                }
            }
        });
    }
    
    // Adicione as novas funções para os gráficos que faltam
    function atualizarGraficoGerenciaMes(dados) {
        const canvas = document.getElementById('chart_gerencia_mes');
        if (!canvas) return;

        const agora = new Date();
        const mesAtual = agora.getMonth();
        const anoAtual = agora.getFullYear();
        const dadosMes = dados.filter(ice => {
            const dateInfo = getDateInfo(ice.data);
            return dateInfo && dateInfo.month === mesAtual && dateInfo.year === anoAtual;
        });
        
        const contagem = {};
        dadosMes.forEach(ice => {
            const gerencia = ice.gerencia || 'Não informado';
            contagem[gerencia] = (contagem[gerencia] || 0) + 1;
        });

        const labels = Object.keys(contagem);
        const values = Object.values(contagem);
        const chartKey = 'gerenciaMes';
        
        destruirGrafico(chartKey);
        
        if (labels.length === 0) {
            criarGraficoVazio('chart_gerencia_mes', chartKey, 'Sem dados de gerência para o mês atual');
            return;
        }
        
        charts[chartKey] = new Chart(canvas.getContext('2d'), {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: ['#4a7c59', '#6b8e5a', '#8fa85c', '#b3c25e', '#d7dc60', '#fbf662', '#f4d03f', '#f7dc6f'],
                    borderWidth: 2, borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right' },
                    title: { display: true, text: 'Gerência por Mês' }
                }
            }
        });
    }

    function atualizarGraficoTipificacaoAnual(dados) {
        const canvas = document.getElementById('chart_tipificacao_anual');
        if (!canvas) return;

        const contagem = {};
        dados.forEach(ice => {
            const tip = ice.tipificacao || 'Não informado';
            contagem[tip] = (contagem[tip] || 0) + 1;
        });

        const labels = Object.keys(contagem);
        const values = Object.values(contagem);
        const chartKey = 'tipificacaoAnual';
        
        destruirGrafico(chartKey);

        if (labels.length === 0) {
            criarGraficoVazio('chart_tipificacao_anual', chartKey, 'Sem dados de tipificação para o ano');
            return;
        }

        charts[chartKey] = new Chart(canvas.getContext('2d'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Contagem Anual',
                    data: values,
                    backgroundColor: '#4a7c59',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                },
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: 'Tipificação Anual' }
                }
            }
        });
    }

    function atualizarGraficoGerenciaAnual(dados) {
        const canvas = document.getElementById('chart_gerencia_anual');
        if (!canvas) return;

        const contagem = {};
        dados.forEach(ice => {
            const gerencia = ice.gerencia || 'Não informado';
            contagem[gerencia] = (contagem[gerencia] || 0) + 1;
        });

        const labels = Object.keys(contagem);
        const values = Object.values(contagem);
        const chartKey = 'gerenciaAnual';
        
        destruirGrafico(chartKey);

        if (labels.length === 0) {
            criarGraficoVazio('chart_gerencia_anual', chartKey, 'Sem dados de gerência para o ano');
            return;
        }

        charts[chartKey] = new Chart(canvas.getContext('2d'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Contagem Anual',
                    data: values,
                    backgroundColor: '#6b8e5a',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                },
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: 'Gerência Anual' }
                }
            }
        });
    }

    function atualizarGraficoBcsComparativo(dados) {
        const canvas = document.getElementById('chart_bcs_comparativo');
        if (!canvas) return;
        
        const contagem = {};
        dados.forEach(ice => {
            const dateInfo = getDateInfo(ice.data);
            if (!dateInfo) return;
            const ano = dateInfo.year;
            const bcs = parseInt(ice.quantidade_bcs) || 0;
            contagem[ano] = (contagem[ano] || 0) + bcs;
        });

        const labels = Object.keys(contagem).sort();
        const values = labels.map(ano => contagem[ano]);
        const chartKey = 'bcsComparativo';
        
        destruirGrafico(chartKey);
        
        if (labels.length === 0) {
            criarGraficoVazio('chart_bcs_comparativo', chartKey, 'Sem dados de BCS');
            return;
        }

        charts[chartKey] = new Chart(canvas.getContext('2d'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Total de BCS',
                    data: values,
                    borderColor: '#f7dc6f',
                    backgroundColor: 'rgba(247, 220, 111, 0.2)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1 } }
                },
                plugins: {
                    title: { display: true, text: 'BCS Comparativo Anual' }
                }
            }
        });
    }
    
    function atualizarTodosGraficos() {
        console.log('=== ATUALIZANDO TODOS OS GRÁFICOS ===');
        const dadosFiltrados = filtrarDadosPorPeriodo();
        
        const agora = new Date();
        const ultimaAtualizacao = document.getElementById('ultima_atualizacao');
        if (ultimaAtualizacao) {
            ultimaAtualizacao.textContent = agora.toLocaleDateString('pt-BR') + ' ' +
                agora.getHours().toString().padStart(2, '0') + ':' +
                agora.getMinutes().toString().padStart(2, '0');
        }

        if (dadosFiltrados.length === 0) {
            console.log('Nenhum dado encontrado, criando gráficos vazios');
            criarTodosGraficosVazios();
            mostrarErro('Nenhum dado encontrado para o período selecionado');
            return;
        }
        
        const errorMsg = document.querySelector('.error-message');
        if (errorMsg) errorMsg.remove();
        
        try {
            atualizarGraficoComparativoAnos(dadosFiltrados);
            atualizarGraficoTipificacaoMes(dadosFiltrados);
            atualizarGraficoTipificacaoPorMes(dadosFiltrados);
            atualizarGraficoEvolucaoMensal(dadosFiltrados);
            // Novos gráficos adicionados para completar a lista
            atualizarGraficoBcsMes(dadosFiltrados);
            atualizarGraficoGerenciaMes(dadosFiltrados);
            atualizarGraficoTipificacaoAnual(dadosFiltrados);
            atualizarGraficoGerenciaAnual(dadosFiltrados);
            atualizarGraficoBcsComparativo(dadosFiltrados);

            console.log('Todos os gráficos foram atualizados com sucesso!');
        } catch (error) {
            console.error('Erro ao atualizar gráficos:', error);
            mostrarErro('Erro ao atualizar gráficos: ' + error.message);
        }
    }

    // --- Funções de KPIs ---
    function atualizarKPIs() {
        console.log('Atualizando KPIs...');
        const dadosFiltrados = filtrarDadosPorPeriodo();
        
        document.querySelectorAll('.metric-card').forEach(card => card.classList.remove('shimmer'));
        
        const totalIces = dadosFiltrados.length;
        const acionamentosReais = dadosFiltrados.filter(ice => ice.acionamento_real === 'sim').length;
        const simulados = dadosFiltrados.filter(ice => ice.acionamento_real === 'simulado').length;
        const taxaReal = totalIces > 0 ? ((acionamentosReais / totalIces) * 100).toFixed(1) : 0;
        
        const totalBcs = dadosFiltrados.reduce((total, ice) => total + (parseInt(ice.quantidade_bcs) || 0), 0);
        
        animateNumber('total_ices', totalIces);
        animateNumber('acionamentos_reais', acionamentosReais);
        animateNumber('simulados', simulados);
        animateNumber('total_bcs', totalBcs);
        document.getElementById('taxa_real').textContent = taxaReal + '%';
        
        console.log('KPIs atualizados:', { totalIces, acionamentosReais, simulados, taxaReal, totalBcs });
    }

    function animateNumber(elementId, targetValue) {
        const element = document.getElementById(elementId);
        if (!element) return;
        const startValue = 0;
        const duration = 1500;
        const startTime = performance.now();
        function updateNumber(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const easedProgress = 1 - Math.pow(1 - progress, 3);
            const currentValue = Math.floor(startValue + (targetValue - startValue) * easedProgress);
            element.textContent = currentValue.toLocaleString('pt-BR');
            if (progress < 1) requestAnimationFrame(updateNumber);
        }
        requestAnimationFrame(updateNumber);
    }
    
    // --- Funções Principais do Dashboard ---
    async function carregarDadosDashboard() {
        console.log('Carregando dados do dashboard...');
        const metricCards = document.querySelectorAll('.metric-card');
        metricCards.forEach(card => card.classList.add('shimmer'));
        
        try {
            const responseIce = await callAPI('GET', 'listarIce');
            
            if (responseIce.status === 'success' && Array.isArray(responseIce.ice)) {
                dadosIce = responseIce.ice;
                console.log('Dados ICE carregados:', dadosIce.length, 'registros');
                atualizarKPIs();
                setTimeout(() => atualizarTodosGraficos(), 500);
            } else {
                console.error('Erro ao carregar ICEs: Formato de dados inesperado.', responseIce);
                dadosIce = [];
                atualizarKPIs();
                criarTodosGraficosVazios();
                mostrarErro('Erro no formato dos dados da API.');
            }
        } catch (error) {
            console.error('Erro ao carregar dados do dashboard:', error);
            metricCards.forEach(card => {
                card.textContent = '0';
                card.classList.remove('shimmer');
            });
            criarTodosGraficosVazios();
            mostrarErro('Erro ao carregar dados: ' + error.message);
        }
    }

    function atualizarDashboard() {
        console.log('Atualizando dashboard manualmente...');
        const errorMsg = document.querySelector('.error-message');
        if (errorMsg) errorMsg.remove();
        carregarDadosDashboard();
    }
    
    // --- Listeners de Eventos e Inicialização ---
    document.addEventListener('DOMContentLoaded', function() {
        const filtroPeriodo = document.getElementById('filtro_periodo');
        if (filtroPeriodo) {
            filtroPeriodo.addEventListener('change', function() {
                const valor = this.value;
                const dataInicio = document.getElementById('data_inicio');
                const dataFim = document.getElementById('data_fim');
                const isCustom = valor === 'personalizado';
                if (dataInicio && dataFim) {
                    dataInicio.style.display = isCustom ? 'block' : 'none';
                    dataFim.style.display = isCustom ? 'block' : 'none';
                }
                setTimeout(() => {
                    if (dadosIce.length > 0) {
                        atualizarKPIs();
                        atualizarTodosGraficos();
                    }
                }, 100);
            });
        }
        
        const dataInicio = document.getElementById('data_inicio');
        const dataFim = document.getElementById('data_fim');
        if (dataInicio) dataInicio.addEventListener('change', () => {
            if (document.getElementById('filtro_periodo').value === 'personalizado') {
                setTimeout(() => { atualizarKPIs(); atualizarTodosGraficos(); }, 100);
            }
        });
        if (dataFim) dataFim.addEventListener('change', () => {
            if (document.getElementById('filtro_periodo').value === 'personalizado') {
                setTimeout(() => { atualizarKPIs(); atualizarTodosGraficos(); }, 100);
            }
        });

        const btnAjuda = document.getElementById('btn_ajuda');
        if (btnAjuda) {
            btnAjuda.addEventListener('click', function() {
                alert("Sistema de Monitoramento ICE - Ajuda\n\n" +
                    "Este dashboard permite monitorar os indicadores de ICE (Índice de Controle de Emergência).\n\n" +
                    "Para utilizar os filtros, selecione o período desejado no campo 'Período' e clique em 'Atualizar Dashboard'.\n\n" +
                    "Os gráficos são interativos: passe o mouse sobre eles para ver detalhes específicos.");
            });
        }
    });

    window.addEventListener('load', function() {
        console.log('Dashboard ICE inicializando...');
        const hoje = new Date();
        const dataInicio = document.getElementById('data_inicio');
        const dataFim = document.getElementById('data_fim');
        if (dataFim) dataFim.valueAsDate = hoje;
        if (dataInicio) {
            const mesPassado = new Date();
            mesPassado.setMonth(hoje.getMonth() - 1);
            dataInicio.valueAsDate = mesPassado;
        }
        setTimeout(async () => {
            try {
                console.log('Iniciando carregamento dos dados...');
                await carregarDadosDashboard();
                console.log('Dashboard ICE inicializado com sucesso!');
            } catch (error) {
                console.error('Erro na inicialização:', error);
                mostrarErro('Erro ao inicializar o dashboard. Verifique a conexão com a API.');
            }
        }, 1000);
    });

    window.atualizarDashboard = atualizarDashboard;
</script>
<section>
</html>
